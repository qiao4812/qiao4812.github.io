---
title: "《Rust编程之道》学习笔记"
date: 2023-08-08T20:57:40+08:00
lastmod: 2023-08-08T20:57:40+08:00 
draft: false
categories:
- Rust
tags:
- Rust
---

# 《Rust编程之道》学习笔记

## 序

### Rust语言的主要特点

- 系统级语言
- 无GC
- 基于LLVM
- 内存安全
- 强类型+静态类型
- 混合编程范式
- 零成本抽象
- 线程安全

### 程序员的快乐

何谓快乐？真正的快乐不仅仅是写代码时的“酸爽”，更应该是代码部署到生产环境之后的“安稳”。

### 程序的三大定律

- 程序必须正确
- 程序必须可维护，但不能违反第一条定律
- 程序必须高效，但不能违反前两条定律

### 程序的正确性

- 程序满足了实际的问题需求
- 满足了自身的程序规约

### 如何保证程序的正确性

- 通过对程序的各种测试、断言和错误处理机制，来保证其满足实际的问题需求。
- 通过较为成熟的类型理论，来保证程序自身的规约正确。

Rust语言对程序的三定律支持的恰到好处。

目前Rust被陆续应用在区块链、游戏、WebAssembly 技术、机器学习，分布式数据库、网络服务基础设施、Web框架、操作系统和嵌入式等领域。

## 前言

Rust 学习曲线陡的根本原因在于 Rust 语言融合了多种语言特性和多种编程范式。

从Rust 的设计哲学出发，牢牢把握它的设计一致性，就可以把它的所有特性都串起来，从而达到掌握它的目的。

### 《Rust 编程之道》特点

- 从设计哲学出发，探索 Rust 语言的内在一致性。
  - 设计哲学是一门优秀编程语言报错语言一致性的关键所在。
  - 设计哲学是语言特性和语法要素设计的诱因和准则。
- 从源码分析入手，探索 Rust 地道的编程风格。
- 从工程角度着手，探索 Rust 对健壮性的支持。
- 从底层原理开始，探索 Rust 内存安全的本质。

### 章节概述

第一章 新时代的语言

第二章 语言精要

第三章 类型系统

第四章 内存管理

第五章 所有权系统

第六章 函数、闭包和迭代器

第七章 结构化编程

第八章 字符串与集合类型

第九章 构建健壮的程序

第十章 模块化编程

第十一章 安全并发

第十二章 元编程

第十三章 超越安全的边界

## 第 1 章 新时代的语言

不谋全局者，不足谋一域。

一门好的语言是有内涵哲学的语言，它表里如一，有所想，有所为。

### 两个难题

- 很难编写内存安全的代码。
- 很难编写线程安全的代码。

Ada 语言

2006 年，自称 “职业编程语言工程师” 的 Graydon Hoare（简称为 GH），开始开发一门名为 Rust 的编程语言。

什么是 “职业编程语言工程师”？用 GH 自己的话说，职业编程语言工程师的日常工作就是给其他语言开发编译器和工具集，但并未参与这些语言本身的设计。

### GH 对 Rust 语言的期望

- 必须是更加安全、不易崩溃的，尤其在操作内存时，这一点更为重要。
- 不需要有垃圾回收这样的系统，不能为了内存安全而引入性能负担。
- 不是一门仅仅拥有一个主要特性的语言，而应该拥有一系列的广泛特性，这些特性之间又不乏一致性。这些特性可以很好地相互协作，从而使该语言更容易编写、维护和调试，让程序员写出更安全、更高效的代码。

Rust 是一门同时追求安全、并发和性能的现代系统级编程语言。

### 设计哲学

- 内存安全
- 零成本抽象
- 实用性

有些事现在不做，一辈子都没机会再做了。    -- 练习曲[2006]

“程序即类型证明”

### 类型系统的好处

- 允许编译器侦测无意义甚至无效的代码，暴露程序中隐含的错误。
- 可以为编译器提供有意义的类型信息，帮助优化代码。
- 可以增强代码的可读性，更直白地阐述开发者的意图。
- 提供了一定程度的高级抽象，提升开发效率。

简单来说，类型安全是指类型系统可以保证程序的行为是意义明确、不出错的。

未定义行为（Undefined Behavior）：发生了语言规范规定之外的行为。

Rust语言如果想保证内存安全，首先要做的就是保证类型安全。

类型安全的语言：OCaml、Haskell

类型系统的作用是定义编程语言中值和表达式的类型，将它们归类，赋予它们不同的行为，指导它们如何相互作用。

### 内存安全

什么是内存安全？简单来说，就是不会出现内存访问错误。

只有当程序访问未定义内存的时候才会产生内存错误。

一般来说，发生以下几种情况就会产生内存错误：

- 引用空指针
- 使用未初始化内存
- 释放后使用，也就是使用悬垂指针
- 缓冲区溢出，比如数组越界
- 非法释放已经释放过的指针或未分配的指针，也就是重复释放

### Rust 语言安全内存管理模型

- 所有权系统
  - 每个被分配的内存都有一个独占其所有权的指针
  - 只有当该指针被销毁时，其对应的内存才能随之被释放
  - RAII 机制
- 借用和生命周期
  - 每个变量都有其生命周期，一旦超出生命周期，变量就会被自动释放
  - 如果是借用，则可以通过标记生命周期参数供编译器检查的方式，防止出现悬垂指针，也就是释放后使用的情况。

### Rust 从 Haskell 的类型系统借鉴了以下特性：

- 没有空指针
- 默认不可变
- 表达式
- 高阶函数
- 代数数据类型
- 模式匹配
- 泛型
- Trait 和关联类型
- 本地类型推导

### Rust 独有的特性

- 仿射类型（Affine Type），该类型用来表达 Rust所有权中的 Move 语义
- 借用、生命周期

Rust 编译器可以在编译期对类型进行检查，看其是否满足安全内存模型，在编译器就能发现内存不安全问题，有效地阻止未定义行为的发生。

Rust 编译器会通过静态检查分析，在编译器就检查出多线程并发代码中所有的数据竞争问题。

### 零成本抽象

Rust 的抽象并不会存在运行时性能开销，这一切都是在编译期完成的。

Rust 中零成本抽象的基石就是泛型和Trait。

### 实用性

如何评价一门编程语言的实用性？

- 实践性
- 有益性
- 稳定性







